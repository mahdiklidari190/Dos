<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>عضویت رسمی | انجمن دوستداران طبیعت خراسان شمالی</title>

  <!-- Vazirmatn Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;900&display=swap" rel="stylesheet"/>

  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>

  <!-- Persian Datepicker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

  <!-- QR Code & Canvas -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary: #1b4332;
      --primary-dark: #081c15;
      --primary-light: #2d6a4f;
      --accent: #40916c;
      --light: #f8fffa;
      --text: #e9f5f0;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(135deg, #081c15 0%, #1b4332 50%, #2d6a4f 100%);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 480px;
      background: rgba(27, 67, 50, 0.25);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header img {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      border: 5px solid var(--accent);
      object-fit: cover;
    }
    .header h1 {
      font-size: 26px;
      margin: 15px 0 8px;
      color: white;
    }
    .header p {
      color: #a8dadc;
      font-size: 15px;
    }
    .form-group {
      position: relative;
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #d8f3dc;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 45px 14px 14px;
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 16px;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(64, 145, 108, 0.3);
    }
    .form-group i {
      position: absolute;
      left: 14px;
      top: 48px;
      color: #a8dadc;
    }
    .gender-group {
      display: flex;
      gap: 25px;
      justify-content: center;
    }
    .interest-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .chip {
      padding: 10px 16px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .chip.selected {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn {
      width: 100%;
      padding: 15px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s;
      margin-top: 15px;
    }
    .btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 20px rgba(64,145,108,0.4);
    }
    .link { color: #95d5b2; text-decoration: none; font-weight: 500; }
    .link:hover { text-decoration: underline; }
    .error { color: #ff6b6b; font-size: 14px; margin-top: 5px; }
    .success { color: #95d5b2; font-weight: bold; margin: 15px 0; text-align: center; }

    /* ID Card */
    #idCard {
      width: 380px;
      height: 600px;
      margin: 30px auto;
      background: white;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.4);
      position: relative;
      color: #111;
      font-size: 14px;
    }
    .card-header-strip {
      background: linear-gradient(to right, var(--primary-dark), var(--primary), var(--accent));
      padding: 15px;
      text-align: center;
      color: white;
      position: relative;
    }
    .card-header-strip img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      position: absolute;
      left: 15px;
      top: 10px;
      border: 3px solid white;
    }
    .card-header-strip h3 { font-size: 20px; margin: 0; }
    .card-watermark {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://images.unsplash.com/photo-1502086223501-09b7e5f7dd16?w=800&q=10') center/cover;
      opacity: 0.07;
      pointer-events: none;
    }
    .card-photo {
      width: 130px;
      height: 150px;
      margin: 20px auto;
      border: 5px solid var(--primary);
      border-radius: 12px;
      overflow: hidden;
      background: #eee;
    }
    .card-photo img { width: 100%; height: 100%; object-fit: cover; }
    .card-info { padding: 0 25px; line-height: 2.1; }
    .card-info strong { color: var(--primary); }
    #qrCode { margin: 20px auto; text-align: center; }
    .signature {
      text-align: center;
      margin: 25px 0;
    }
    .signature-line {
      width: 160px;
      height: 2px;
      background: var(--primary);
      margin: 10px auto;
    }
    .card-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--primary-dark);
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 12px;
    }
    @media (max-width: 480px) {
      .container { padding: 20px; }
      #idCard { width: 340px; height: 540px; }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <img src="https://via.placeholder.com/150/1b4332/ffffff?text=لوگو" alt="لوگوی انجمن"/>
    <h1>انجمن دوستداران طبیعت خراسان شمالی</h1>
    <p>عضویت رسمی و صدور کارت شناسایی دیجیتال</p>
  </div>

  <!-- Signup -->
  <div id="signup">
    <h2 style="text-align:center;color:white;margin-bottom:20px;">فرم ثبت‌نام</h2>

    <div class="form-group">
      <label>نام</label>
      <i class="fas fa-user"></i>
      <input type="text" id="name" placeholder="نام خود را وارد کنید"/>
      <div class="error" id="nameError"></div>
    </div>

    <div class="form-group">
      <label>نام خانوادگی</label>
      <i class="fas fa-user"></i>
      <input type="text" id="family" placeholder="نام خانوادگی"/>
      <div class="error" id="familyError"></div>
    </div>

    <div class="form-group">
      <label>کد ملی</label>
      <i class="fas fa-id-card"></i>
      <input type="text" id="nationalCode" maxlength="10" placeholder="کد ملی ۱۰ رقمی"/>
      <div class="error" id="nationalCodeError"></div>
    </div>

    <div class="form-group">
      <label>تاریخ تولد (شمسی)</label>
      <i class="fas fa-calendar-alt"></i>
      <input type="text" id="birthdate" class="persian-datepicker" placeholder="تاریخ تولد را انتخاب کنید"/>
      <div class="error" id="birthdateError"></div>
    </div>

    <div class="form-group">
      <label>شماره همراه</label>
      <i class="fas fa-phone"></i>
      <input type="text" id="phone" maxlength="11" placeholder="۰۹xxxxxxxxx"/>
      <div class="error" id="phoneError"></div>
    </div>

    <div class="form-group">
      <label>جنسیت</label>
      <div class="gender-group">
        <label><input type="radio" name="gender" value="male"> مرد</label>
        <label><input type="radio" name="gender" value="female"> زن</label>
      </div>
      <div class="error" id="genderError"></div>
    </div>

    <div class="form-group">
      <label>تحصیلات</label>
      <i class="fas fa-graduation-cap"></i>
      <input type="text" id="education" placeholder="تحصیلات"/>
    </div>

    <div class="form-group">
      <label>آدرس محل سکونت</label>
      <i class="fas fa-home"></i>
      <textarea id="address" rows="3" placeholder="آدرس کامل"></textarea>
    </div>

    <div class="form-group">
      <label>عکس پرسنلی</label>
      <input type="file" id="profileImage" accept="image/*" style="color:white;"/>
      <img id="profilePreview" src="" alt="پیش‌نمایش" style="display:none;width:100px;height:100px;border-radius:50%;margin-top:10px;"/>
    </div>

    <div class="form-group">
      <label>سابقه فعالیت محیط‌زیستی (سال)</label>
      <input type="number" id="experience" min="0" placeholder="چند سال؟ (در صورت نداشتن ۰ وارد کنید)"/>
    </div>

    <div class="form-group">
      <label>علاقه‌مندی به فعالیت در کدام بخش؟ (حداقل یکی)</label>
      <div class="interest-chips">
        <div class="chip" data-val="محیط زیست طبیعی">محیط زیست طبیعی</div>
        <div class="chip" data-val="محیط زیست انسانی">محیط زیست انسانی</div>
        <div class="chip" data-val="منابع طبیعی">منابع طبیعی</div>
        <div class="chip" data-val="آموزش جوامع محلی">آموزش جوامع محلی</div>
        <div class="chip" data-val="تولید محتوا">تولید محتوا</div>
        <div class="chip" data-val="هنر و محیط زیست">هنر و محیط زیست</div>
        <div class="chip" data-val="ورزش و محیط زیست">ورزش و محیط زیست</div>
        <div class="chip" data-val="جوانان">جوانان</div>
        <div class="chip" data-val="کودکان">کودکان</div>
        <div class="chip" data-val="هوش مصنوعی">هوش مصنوعی</div>
      </div>
      <div class="error" id="interestsError"></div>
    </div>

    <div class="success" id="signupSuccess"></div>
    <div class="error" id="signupError"></div>

    <button class="btn" onclick="register()">ثبت‌نام در انجمن</button>
    <p style="text-align:center;margin-top:15px;">
      حساب دارید؟ <a href="#" class="link" onclick="showLogin()">ورود به پنل</a>
    </p>
  </div>

  <!-- Login -->
  <div id="login" style="display:none;">
    <h2 style="text-align:center;color:white;margin-bottom:30px;">ورود به پنل کاربری</h2>
    <div class="form-group">
      <label>کد ملی</label>
      <i class="fas fa-id-card"></i>
      <input type="text" id="loginNationalCode" placeholder="کد ملی خود را وارد کنید"/>
    </div>
    <div class="error" id="loginError"></div>
    <button class="btn" onclick="login()">ورود</button>
    <p style="text-align:center;margin-top:15px;">
      حساب ندارید؟ <a href="#" class="link" onclick="showSignup()">ثبت‌نام</a>
    </p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <h2 style="text-align:center;color:white;margin-bottom:20px;">کارت عضویت شما</h2>

    <div id="idCard">
      <div class="card-header-strip">
        <img src="https://via.placeholder.com/150/1b4332/ffffff?text=لوگو" alt="لوگو"/>
        <h3>کارت عضویت رسمی</h3>
      </div>
      <div class="card-watermark"></div>

      <div class="card-photo">
        <img id="cardPhoto" src="" alt="عکس"/>
      </div>

      <div class="card-info">
        <p><strong>نام و نام خانوادگی:</strong> <span id="cardFullName"></span></p>
        <p><strong>کد عضویت:</strong> <span id="cardNationalCode"></span></p>
        <p><strong>تاریخ صدور:</strong> <span id="cardIssueDate"></span></p>
        <p><strong>تاریخ انقضا:</strong> <span id="cardExpiryDate"></span></p>
        <p><strong>واحد فعالیت:</strong> <span id="cardInterests"></span></p>
      </div>

      <div id="qrCode"></div>

      <div class="signature">
        <div class="signature-line"></div>
        <p>امضای رئیس انجمن</p>
      </div>

      <div class="card-footer">
        انجمن دوستداران طبیعت خراسان شمالی و غرب خراسان رضوی<br/>
        www.nature-khn.ir
      </div>
    </div>

    <button class="btn" onclick="downloadPNG()">دانلود کارت (PNG)</button>
    <button class="btn" onclick="downloadPDF()" style="margin-top:10px;background:#2d6a4f;">دانلود کارت (PDF)</button>
    <button class="btn" onclick="logout()" style="margin-top:20px;background:#c1121f;">خروج از حساب</button>
  </div>
</div>

<script>
  const { jsPDF } = window.jspdf;
  let currentUser = null;

  // IndexedDB
  let db;
  const request = indexedDB.open("NatureLoversDB", 1);
  request.onupgradeneeded = e => e.target.result.createObjectStore("users", { keyPath: "nationalCode" });
  request.onsuccess = e => db = e.target.result;

  // Persian Datepicker
  $(document).ready(function(){
    $("#birthdate").persianDatepicker({
      format: "YYYY/MM/DD",
      autoClose: true,
      initialValue: false,
      calendar: { persian: { locale: "fa" } }
    });
  });

  // Preview photo
  document.getElementById("profileImage").addEventListener("change", e => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = ev => {
        document.getElementById("profilePreview").src = ev.target.result;
        document.getElementById("profilePreview").style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  // Interest chips
  document.querySelectorAll(".chip").forEach(chip => {
    chip.addEventListener("click", () => {
      chip.classList.toggle("selected");
    });
  });

  // Validation functions (same logic as before, slightly cleaned)
  function validateForm(){
    let valid = true;
    if(!/^[آ-ی\s]+$/.test(document.getElementById("name").value.trim())) valid = false;
    if(!/^[آ-ی\s]+$/.test(document.getElementById("family").value.trim())) valid = false;
    if(!/^\d{10}$/.test(document.getElementById("nationalCode").value)) valid = false;
    if(!document.getElementById("birthdate").value) valid = false;
    if(!/^09\d{9}$/.test(document.getElementById("phone").value)) valid = false;
    if(!document.querySelector('input[name="gender"]:checked')) valid = false;
    if(document.querySelectorAll(".chip.selected").length === 0) valid = false;
    return valid;
  }

  // Register
  function register(){
    if(!validateForm()){
      document.getElementById("signupError").textContent = "لطفاً تمامی فیلدها را درست پر کنید.";
      return;
    }
    const interests = Array.from(document.querySelectorAll(".chip.selected")).map(c=>c.dataset.val).join("، ");
    const user = {
      name: document.getElementById("name").value.trim(),
      family: document.getElementById("family").value.trim(),
      nationalCode: document.getElementById("nationalCode").value,
      birthdate: document.getElementById("birthdate").value,
      phone: document.getElementById("phone").value,
      gender: document.querySelector('input[name="gender"]:checked').value === "male" ? "مرد" : "زن",
      education: document.getElementById("education").value,
      address: document.getElementById("address").value,
      experience: document.getElementById("experience").value || "۰",
      interests,
      photo: document.getElementById("profilePreview").src || ""
    };

    const tx = db.transaction("users","readwrite");
    tx.objectStore("users").put(user);
    tx.oncomplete = () => {
      document.getElementById("signupSuccess").textContent = "ثبت‌نام با موفقیت انجام شد! در حال انتقال به ورود...";
      setTimeout(() => showLogin(), 2000);
    };
  }

  // Login
  function login(){
    const code = document.getElementById("loginNationalCode").value;
    if(!code){ document.getElementById("loginError").textContent="کد ملی را وارد کنید"; return; }
    const tx = db.transaction("users");
    tx.objectStore("users").get(code).onsuccess = e => {
      const user = e.target.result;
      if(user){
        currentUser = user;
        showDashboard(user);
      } else {
        document.getElementById("loginError").textContent="کاربری با این کد ملی یافت نشد";
      }
    };
  }

  // Show Dashboard + Card
  function showDashboard(user){
    document.getElementById("signup").style.display="none";
    document.getElementById("login").style.display="none";
    document.getElementById("dashboard").style.display="block";

    document.getElementById("cardFullName").textContent = `\( {user.name} \){user.family}`;
    document.getElementById("cardNationalCode").textContent = user.nationalCode;
    document.getElementById("cardInterests").textContent = user.interests;
    document.getElementById("cardPhoto").src = user.photo || "https://via.placeholder.com/130x150/cccccc/666666?text=بدون+عکس";

    const today = new Date().toLocaleDateString("fa-IR");
    const expiry = new Date();
    expiry.setFullYear(expiry.getFullYear() + 3);
    document.getElementById("cardIssueDate").textContent = today;
    document.getElementById("cardExpiryDate").textContent = expiry.toLocaleDateString("fa-IR");

    QRCode.toCanvas(document.getElementById("qrCode"), `https://nature-khn.ir/verify?code=${user.nationalCode}`, { width: 110, color:{dark:"#1b4332"} });
  }

  // Download PNG
  function downloadPNG(){
    html2canvas(document.getElementById("idCard"), {scale: 2}).then(canvas => {
      const link = document.createElement("a");
      link.download = `کارت_عضویت_${currentUser.nationalCode}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
  }

  // Download PDF
  function downloadPDF(){
    html2canvas(document.getElementById("idCard"), {scale: 2}).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "mm", [100, 158]); // حدوداً نسبت کارت
      pdf.addImage(imgData, "PNG", 0, 0, 100, 158);
      pdf.save(`کارت_عضویت_${currentUser.nationalCode}.pdf`);
    });
  }

  // Navigation
  function showLogin(){ document.getElementById("signup").style.display="none"; document.getElementById("login").style.display="block"; }
  function showSignup(){ document.getElementById("login").style.display="none"; document.getElementById("signup").style.display="block"; }
  function logout(){
    currentUser = null;
    document.getElementById("dashboard").style.display="none";
    document.getElementById("signup").style.display="block";
  }
</script>
</body>
          </html>
